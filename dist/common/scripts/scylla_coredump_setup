#!/usr/bin/python2
#
# Copyright 2018 ScyllaDB
#

#
# This file is part of Scylla.
#
# Scylla is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Scylla is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Scylla.  If not, see <http://www.gnu.org/licenses/>.

import os
import sys
import argparse
import subprocess
import logging
import distro
import shutil
from scylla_util import is_debian_variant

if __name__ == '__main__':
    if os.getuid() > 0:
        logging.error('Requires root permission.')
        sys.exit(1)
    parser = argparse.ArgumentParser(description='Optimize coredump settings for Scylla.')
    parser.add_argument('--dump-to-raiddir', action='store_true', default=False,
                        help='store coredump to /var/lib/scylla')
    parser.add_argument('--compress', action='store_true', default=False,
                        help='enable compress on systemd-coredump')
    args = parser.parse_args()

# Ubuntu 14.04 not used systemd, so use scylla_save_coredump
    if distro.id() == 'ubuntu' and distro.version() == '14.04':
        subprocess.check_call(['apt-get', 'remove', '-y', 'apport-noui'])
        subprocess.check_call(['sysctl', '-p', '/etc/sysctl.d/99-scylla-coredump.conf'])
# Debian 8 uses systemd but it's too old to use systemd-coredump, so
# use scylla_save_coredump too
    elif distro.id() == 'debian' and distro.version() == '8':
        subprocess.check_call(['sysctl', '-p', '/etc/sysctl.d/99-scylla-coredump.conf'])
# Gentoo may uses OpenRC
    elif distro.id() == 'gentoo':
        subprocess.check_call(['sysctl', '-p', '/etc/sysctl.d/99-scylla-coredump.conf'])
# Other distributions can use systemd-coredump, so setup it
    else:
        if is_debian_variant():
            subprocess.check_call(['apt-get', 'install', '-y', 'systemd-coredump'])
        conf_data = '''
[Coredump]
Storage=external
Compress={compress}
ProcessSizeMax=1024G
ExternalSizeMax=1024G
'''[1:-1].format(compress = 'yes' if args.compress else 'no')
        conf = open('/etc/systemd/coredump.conf', 'w')
        conf.write(conf_data)
        conf.close
        if args.dump_to_raiddir:
            shutil.rmtree('/var/lib/systemd/coredump')
            os.mkdir('/var/lib/scylla/coredump')
            os.symlink('/var/lib/scylla/coredump', '/var/lib/systemd/coredump')
        subprocess.check_call(['systemctl', 'daemon-reload'])
        if is_debian_variant():
            subprocess.check_call(['sysctl', '-p', '/usr/lib/sysctl.d/50-coredump.conf'])
        else:
            subprocess.check_call(['sysctl', '-p', '/etc/sysctl.d/99-scylla-coredump.conf'])
