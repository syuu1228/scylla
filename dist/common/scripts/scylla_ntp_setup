#!/usr/bin/python2
#
# Copyright 2018 ScyllaDB
#

#
# This file is part of Scylla.
#
# Scylla is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Scylla is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Scylla.  If not, see <http://www.gnu.org/licenses/>.

import os
import sys
import argparse
import subprocess
import logging
import re
from scylla_util import *

if __name__ == '__main__':
    if os.getuid() > 0:
        logging.error('Requires root permission.')
        sys.exit(1)

    parser = argparse.ArgumentParser(description='Optimize NTP client setting for Scylla.')
    if is_redhat_variant():
        parser.add_argument('--subdomain',
                            help='specify subdomain of pool.ntp.org (ex: centos, fedora or amazon)')
    args = parser.parse_args()

    if is_debian_variant():
        subprocess.check_call(['apt-get', 'install', '-y', 'ntp', 'ntpdate'])
        subprocess.check_call(['service', 'ntp', 'stop'])
        f = open('/etc/ntp.conf')
        conf = f.read()
        f.close()
        if not re.match(r'^server ', conf, flags=re.MULTILINE):
            conf2 = re.findall(r'^(?!pool).*\n', conf, flags=re.MULTILINE)
            f = open('/etc/ntp.conf', 'w')
            f.writelines(conf2)
            f.write('server ntp.ubuntu.com iburst')
            f.close()
        subprocess.check_call(['ntpdate', 'ntp.ubuntu.com'])
        subprocess.check_call(['service', 'ntp', 'start'])

    if is_gentoo_variant():
        subprocess.check_call(['emerge', '-uq', 'net-misc/ntp'])
        p = subprocess.Popen(['pidof', 'ntpd'], stdout=subprocess.PIPE)
        p.wait()
        if p.returncode != 0:
            f = open('/etc/ntp.conf')
            conf = f.read()
            f.close()
            match = re.search(r'^server\s+(\S*)(\s+\S+)?', conf, flags=re.MULTILINE)
            subprocess.check_call(['ntpdate', match.group(1)])
            if is_systemd():
                subprocess.check_call(['systemctl', 'enable', 'sntpd.service'])
                subprocess.check_call(['systemctl', 'start', 'sntpd.service'])
            else:
                subprocess.check_call(['rc-update', 'add', 'ntpd', 'default'])
                subprocess.check_call(['rc-service', 'ntpd', 'start'])

    if is_redhat_variant():
        subprocess.call(['yum', 'install', '-y', 'ntp', 'ntpdate'])
        f = open('/etc/ntp.conf')
        conf = f.read()
        f.close()
        if args.subdomain:
            conf2 = re.sub(r'server\s+([0-9]+)\.(\S+)\.pool\.ntp\.org', 'server \\1.{}.pool.ntp.org'.format(args.subdomain), conf, flags=re.MULTILINE)
            f = open('/etc/ntp.conf', 'w')
            f.write(conf2)
            f.close()
            conf = conf2
        ntpd = systemd_unit('ntpd.service')
        if ntpd.is_active():
            ntpd.stop()
        match = re.search(r'^server\s+(\S*)(\s+\S+)?', conf, flags=re.MULTILINE)
        subprocess.check_call(['ntpdate', match.group(1)])
        ntpd.enable()
        ntpd.start()
