#!/bin/bash

set -e

if [ "$1" = configure ]; then
    getent passwd scylla || NOUSR=1
    getent group scylla || NOGRP=1

    # this handles both case group is not exist || group already exists
    if [ $NOUSR ]; then
        adduser --system \
                --quiet \
                --home /var/lib/scylla \
                --no-create-home \
                --disabled-password \
                --group scylla
    # only group is not exist, create it and add user to the group
    elif [ $NOGRP ]; then
        addgroup --system scylla
        adduser scylla scylla
    fi
    chown -R scylla:scylla /var/lib/scylla
    chown -R scylla:scylla /var/lib/scylla-housekeeping
fi

ln -sfT /etc/scylla /var/lib/scylla/conf
if [ -d /usr/lib/scylla ]; then
    mv /usr/lib/scylla /usr/lib/scylla.old
fi
ln -sfT /opt/scylladb/scripts /usr/lib/scylla

grep -v api_ui_dir /etc/scylla/scylla.yaml | grep -v api_doc_dir > /tmp/scylla.yaml
echo "api_ui_dir: /opt/scylladb/swagger-ui/dist/" >> /tmp/scylla.yaml
echo "api_doc_dir: /opt/scylladb/api/api-doc/" >> /tmp/scylla.yaml
mv /tmp/scylla.yaml /etc/scylla/scylla.yaml

/opt/scylladb/scripts/scylla_post_install.sh

#DEBHELPER#
